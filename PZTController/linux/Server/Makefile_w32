CC = i586-mingw32msvc-gcc
CC = i686-w64-mingw32-gcc
INCLUDE_LOCAL = /home/steve/projects/zonge/firmware/include
LIB_LOCAL = /home/steve/projects/include
vpath %.h $(INCLUDE_LOCAL)
vpath %.hpp $(INCLUDE_LOCAL)
vpath %.c $(LIB_LOCAL)
vpath %.cpp $(LIB_LOCAL)
vpath %.o $(LIB_LOCAL)
vpath %.a $(LIB_LOCAL)
EXTRAINCDIRS = . ./../../../../include/ $(INCLUDE_LOCAL)
EXTRA_LIBDIRS = . ./../lib/ $(LIB_LOCAL)
CFLAGS += -std=gnu++11 $(patsubst %,-I%,$(EXTRAINCDIRS))
CFLAGS += -static -m32 -Wall -O0 -g -Wl,--subsystem,console -DDEBUG -mno-ms-bitfields
#LDFLAGS += -static-libgcc -static-libstdc++
LDFLAGS += $(patsubst %,-L%,$(EXTRA_LIBDIRS))
LDFLAGS += $(patsubst %,-l%,$(EXTRA_LIBS))

HGVERSION:= $(shell expr 1 + `hg -q parents --template '{rev}'`)
BUILDNUM:= $(shell bquery Main)
CFLAGS += -DHGVERSION="\"${HGVERSION}\"" -DBUILDNUM="\"${BUILDNUM}\""

%.o: %.cpp
	$(CC) $(CFLAGS) -g -I. -c $< -o $@

%.o: %.c
	$(CC) $(CFLAGS) -g -I. -c $< -o $@
	
Zen457Server: Zen457ServerArchitecture.dot *.h *.hpp main.o ClientConnection.o ZenConnection.o AsciiCmdUserInterface.o CmdHandlersAscii.o CmdTableAscii.o CmdHandlersSocket.o CmdTableSocket.o $(INCLUDE_LOCAL)/stdintle.o $(INCLUDE_LOCAL)/uart/CmdSystem.o $(INCLUDE_LOCAL)/rf/ZongeProtocol.o $(INCLUDE_LOCAL)/format/formatf_stdio.o $(INCLUDE_LOCAL)/format/src/format.o $(INCLUDE_LOCAL)/timing/ZongeHwTypes.o 
	btracer Main
	$(CC) main.o ClientConnection.o ZenConnection.o AsciiCmdUserInterface.o CmdHandlersAscii.o CmdTableAscii.o CmdHandlersSocket.o CmdTableSocket.o $(INCLUDE_LOCAL)/stdintle.o $(INCLUDE_LOCAL)/uart/CmdSystem.o $(INCLUDE_LOCAL)/rf/ZongeProtocol.o $(INCLUDE_LOCAL)/format/formatf_stdio.o $(INCLUDE_LOCAL)/format/src/format.o $(INCLUDE_LOCAL)/timing/ZongeHwTypes.o -g -o Zen457Server $(CFLAGS) $(LDFLAGS) -pthread -L. -L/lib -L/usr/lib -L/usr/local/lib -lstdc++ -lm -lws2_32
	cp $@ builds/Zen457Server.v$(HGVERSION).b$(BUILDNUM).exe
	#gcc main.o -o Zen457Server -L/lib -L/usr/lib -L/usr/local/lib -lc -lstdc++ -lm -lboost_filesystem-mt

all: Zen457Server

program: all
	#~ ./Zen457Server

#~ burn:
	#~ ./Zen457Server

clean:
	-rm *.o
	-rm $(INCLUDE_LOCAL)/stdintle.o
	-rm $(INCLUDE_LOCAL)/rf/ZongeProtocol.o
	-rm $(INCLUDE_LOCAL)/format/formatf_stdio.o
	-rm $(INCLUDE_LOCAL)/format/src/format.o
	-rm $(INCLUDE_LOCAL)/timing/ZongeHwTypes.o
	-rm $(INCLUDE_LOCAL)/uart/CmdSystem.o
	-rm Zen457Server
	-killall Zen457Server
